<?php
	
$IN_FILE = "tempconv.txt";
$OUT_FILE = "tempconv.asm";

// Purpose: Converts db declarations to ASCII mapper for TextDef/TextC structures
require "lib/common.php";

$asmfile = file($IN_FILE);
$h = fopen($OUT_FILE, 'w');

// Conversion table to bizzarro JIS
const CONV_TABLE = [
	"↓",
	"←",
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	" ",
	"!",
	null,
	null,
	null,
	null,
	null,
	"'",
	"(",
	")",
	null,
	"+",
	",",
	"-",
	".",
	null,
	"0",
	"1",
	"2",
	"3",
	"4",
	"5",
	"6",
	"7",
	"8",
	"9",
	":",
	null,
	null,
	null,
	null,
	"?",
	"<r.>",
	"A",
	"B",
	"C",
	"D",
	"E",
	"F",
	"G",
	"H",
	"I",
	"J",
	"K",
	"L",
	"M",
	"N",
	"O",
	"P",
	"Q",
	"R",
	"S",
	"T",
	"U",
	"V",
	"W",
	"X",
	"Y",
	"Z",
	null,
	null,
	null,
	null,
	null,
	"`",
	"a",
	"b",
	"c",
	"d",
	"e",
	"f",
	"g",
	"h",
	"i",
	"j",
	"k",
	"l",
	"m",
	"n",
	"o",
	"p",
	"q",
	"r",
	"s",
	"t",
	"u",
	"v",
	"w",
	"x",
	"y",
	"z",
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
];

for ($chnum = $i = 0; $i < count($asmfile);) {
	$label = trim(get_label($asmfile[$i]));
	if (str_starts_with($label, "TextC") || str_starts_with($label, "TextDef")) {
		fwrite($h, "{$label}:\r\n");
		
		// Additional field at the beginning for TextDefs
		if (str_starts_with($label, "TextDef")) {
			$addr = get_dw($asmfile, $i);
			fwrite($h, "\tdw \${$addr}\r\n");
			$i += 2;
		}
		
		// String length
		$count_str = get_db($asmfile[$i]);
		fwrite($h, "\tdb .end-.start\r\n.start:\r\n");
		++$i;
		
		// String
		
		for ($j = 0, $b = "", $count = hexdec($count_str); $j < $count; $j++) {
			$char = hexdec(get_db($asmfile[$i]));
			++$i;
			
			if ($char == 255) {
				if ($b === "") {
					fwrite($h, "\tdb C_NL\r\n");
				} else {
					fwrite($h, "\tdb \"".addslashes($b)."\", C_NL\r\n");
					$b = "";
				}
			} else if (isset(CONV_TABLE[$char])) {
				$b .= CONV_TABLE[$char];
			} else {
				$b .= chr($char);
			}
		}
		if ($b !== "") {
			fwrite($h, "\tdb \"".addslashes($b)."\"\r\n");
		}
		fwrite($h, ".end:\r\n");
	} else {
		fwrite($h, $asmfile[$i]);
		++$i;
	}
}
fclose($h);